{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/io-t-webpage%20%282%29/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\n/**\r\n * Create a server-side Supabase client using the Service Role Key.\r\n * This client has elevated privileges and MUST only be used on the server.\r\n */\r\nexport function createAdminClient() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n  if (!url || !key) {\r\n    throw new Error('Missing Supabase URL or Service Role Key for admin client')\r\n  }\r\n\r\n  return createClient(url, key)\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAMO,SAAS;IACd,MAAM;IACN,MAAM,MAAM,QAAQ,GAAG,CAAC,yBAAyB;IAEjD,IAAI,CAAC,OAAO,CAAC,KAAK;QAChB,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,yMAAY,EAAC,KAAK;AAC3B"}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///D:/io-t-webpage%20%282%29/app/api/mqtt/ingest/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { createAdminClient } from \"@/lib/supabase/admin\"\r\nimport crypto from \"crypto\"\r\n\r\n/**\r\n * Ingest route for MQTT messages.\r\n * Security: accepts requests either signed with an HMAC (header `x-ingest-signature`)\r\n * using `process.env.MQTT_INGEST_SECRET`, or from an authenticated Supabase user (session cookie).\r\n */\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const raw = await request.text()\r\n\r\n    // HMAC verification\r\n    const signature = request.headers.get(\"x-ingest-signature\")\r\n    const secret = process.env.MQTT_INGEST_SECRET\r\n\r\n    let verified = false\r\n\r\n    if (signature && secret) {\r\n      try {\r\n        const hmac = crypto.createHmac(\"sha256\", secret)\r\n        hmac.update(raw)\r\n        const expected = `sha256=${hmac.digest(\"hex\")}`\r\n        if (crypto.timingSafeEqual(Buffer.from(expected), Buffer.from(signature))) {\r\n          verified = true\r\n        }\r\n      } catch (e) {\r\n        console.warn(\"HMAC verification failed:\", e)\r\n      }\r\n    }\r\n\r\n    // Require HMAC signature only — no session fallback allowed here.\r\n    if (!verified) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n    }\r\n\r\n    const body = JSON.parse(raw || \"{}\")\r\n    const { topic, payload } = body\r\n\r\n    if (!topic || !payload) {\r\n      return NextResponse.json({ error: \"Missing topic or payload\" }, { status: 400 })\r\n    }\r\n\r\n    const supabase = createAdminClient()\r\n\r\n    // Try to find device by mqtt_topic matching the topic\r\n    const { data: device, error: deviceError } = await supabase.from(\"devices\").select(\"id,type\").eq(\"mqtt_topic\", topic).limit(1).single()\r\n\r\n    if (deviceError || !device) {\r\n      return NextResponse.json({ error: \"Device not found for topic\" }, { status: 404 })\r\n    }\r\n\r\n    // payload may be string or object\r\n    const parsed = typeof payload === \"string\" ? (() => {\r\n      try { return JSON.parse(payload) } catch { return { value: payload } }\r\n    })() : payload\r\n\r\n    const value = parsed.value ?? parsed.val ?? null\r\n    const temperature = parsed.temperature ?? parsed.temp ?? null\r\n    const humidity = parsed.humidity ?? null\r\n    const unit = parsed.unit ?? (device.type === \"temperature\" ? \"°C\" : device.type === \"humidity\" ? \"%\" : \"units\")\r\n    const timestamp = parsed.timestamp ?? new Date().toISOString()\r\n\r\n    const { error: insertError } = await supabase.from(\"sensor_data\").insert({\r\n      device_id: device.id,\r\n      value: value ?? 0,\r\n      unit,\r\n      temperature,\r\n      humidity,\r\n      timestamp,\r\n    })\r\n\r\n    if (insertError) {\r\n      console.error(\"Failed to insert sensor_data:\", insertError)\r\n      return NextResponse.json({ error: insertError.message }, { status: 500 })\r\n    }\r\n\r\n    return NextResponse.json({ success: true })\r\n  } catch (err) {\r\n    console.error(\"/api/mqtt/ingest error:\", err)\r\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAOO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,MAAM,MAAM,QAAQ,IAAI;QAE9B,oBAAoB;QACpB,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;QACtC,MAAM,SAAS,QAAQ,GAAG,CAAC,kBAAkB;QAE7C,IAAI,WAAW;QAEf,IAAI,aAAa,QAAQ;YACvB,IAAI;gBACF,MAAM,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU;gBACzC,KAAK,MAAM,CAAC;gBACZ,MAAM,WAAW,CAAC,OAAO,EAAE,KAAK,MAAM,CAAC,QAAQ;gBAC/C,IAAI,gHAAM,CAAC,eAAe,CAAC,OAAO,IAAI,CAAC,WAAW,OAAO,IAAI,CAAC,aAAa;oBACzE,WAAW;gBACb;YACF,EAAE,OAAO,GAAG;gBACV,QAAQ,IAAI,CAAC,6BAA6B;YAC5C;QACF;QAEA,kEAAkE;QAClE,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,OAAO,KAAK,KAAK,CAAC,OAAO;QAC/B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG;QAE3B,IAAI,CAAC,SAAS,CAAC,SAAS;YACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,MAAM,WAAW,IAAA,+IAAiB;QAElC,sDAAsD;QACtD,MAAM,EAAE,MAAM,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,WAAW,MAAM,CAAC,WAAW,EAAE,CAAC,cAAc,OAAO,KAAK,CAAC,GAAG,MAAM;QAErI,IAAI,eAAe,CAAC,QAAQ;YAC1B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA6B,GAAG;gBAAE,QAAQ;YAAI;QAClF;QAEA,kCAAkC;QAClC,MAAM,SAAS,OAAO,YAAY,WAAW,CAAC;YAC5C,IAAI;gBAAE,OAAO,KAAK,KAAK,CAAC;YAAS,EAAE,OAAM;gBAAE,OAAO;oBAAE,OAAO;gBAAQ;YAAE;QACvE,CAAC,MAAM;QAEP,MAAM,QAAQ,OAAO,KAAK,IAAI,OAAO,GAAG,IAAI;QAC5C,MAAM,cAAc,OAAO,WAAW,IAAI,OAAO,IAAI,IAAI;QACzD,MAAM,WAAW,OAAO,QAAQ,IAAI;QACpC,MAAM,OAAO,OAAO,IAAI,IAAI,CAAC,OAAO,IAAI,KAAK,gBAAgB,OAAO,OAAO,IAAI,KAAK,aAAa,MAAM,OAAO;QAC9G,MAAM,YAAY,OAAO,SAAS,IAAI,IAAI,OAAO,WAAW;QAE5D,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,eAAe,MAAM,CAAC;YACvE,WAAW,OAAO,EAAE;YACpB,OAAO,SAAS;YAChB;YACA;YACA;YACA;QACF;QAEA,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,YAAY,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF"}}]
}